<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Critical Care Webinars</title>

  <!-- PapaParse para CSV robusto -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WKDR4C816"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1WKDR4C816');
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #111;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header {
      background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 1.1em; }
    .intro { margin-top: 14px; color: #333; line-height: 1.5; font-size: 0.98em; background: #f8f8ff; border: 1px solid rgba(102,126,234,.25); padding: 12px 14px; border-radius: 10px; }

    .loading { background: white; border-radius: 15px; padding: 40px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
    .error { background: #ffe6e6; border: 2px solid #ff4444; border-radius: 10px; padding: 20px; margin-bottom: 30px; color: #cc0000; }

    .filters { background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
    .filter-actions { display:flex; gap:12px; align-items:center; margin-bottom: 10px; }
    .filter-label { font-weight: bold; color: #667eea; }
    select, input[type="text"] { padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; outline: none; transition: all 0.3s; background: #fff; }
    select:focus, input[type="text"]:focus { border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .toggle-today { background: #fff; color: #764ba2; border: 2px solid #764ba2; padding: 8px 14px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all .2s; }
    .toggle-today.active { background: #764ba2; color:#fff; }

    .day-section { margin-bottom: 30px; }
    .day-header { background: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; transition: all 0.3s; }
    .day-header:hover { background: #f8f9ff; }
    .day-header.past { opacity: 0.6; }
    .day-header.today { background: linear-gradient(135deg, #fff5e6 0%, #ffe6f0 100%); border: 2px solid #667eea; }
    .today-badge { background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: bold; margin-left: 10px; }
    .collapse-icon { font-size: 1.2em; transition: transform 0.3s; }
    .collapsed .collapse-icon { transform: rotate(-90deg); }
    .day-content { overflow: hidden; transition: max-height 0.3s ease-out; }
    .day-content.collapsed { max-height: 0 !important; }
    .day-title { color: #667eea; font-size: 1.5em; font-weight: bold; }
    .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .event-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; border-left: 5px solid #667eea; }
    .event-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .event-time { color: #764ba2; font-weight: bold; font-size: 1.1em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .event-title { color: #333; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; line-height: 1.4; }
    .event-organizer { color: #666; font-size: 0.9em; margin-bottom: 15px; font-style: italic; }
    .event-link, .ics-btn { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s; border: none; cursor: pointer; }
    .event-link:hover, .ics-btn:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
    .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all .3s; }
    .btn-secondary:hover { background: #667eea; color: #fff; }
    .category-tag { display: inline-block; background: #f0f0f0; color: #667eea; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; margin-bottom: 10px; font-weight: 600; }

    .stats { background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
    .stat-item { text-align: center; }
    .stat-number { font-size: 2.5em; color: #667eea; font-weight: bold; }
    .stat-label { color: #666; font-size: 1em; }
    .small-note { font-size: .85em; color:#555; }

    .archive { background: white; border-radius: 15px; padding: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 24px; }
    .accordion { border-top: 1px solid #eee; margin-top: 10px; }
    .accordion-item { border-bottom: 1px solid #eee; }
    .accordion-header { width: 100%; text-align: left; background: #f9f9ff; border: 1px solid rgba(102,126,234,.25); padding: 12px 14px; border-radius: 10px; margin: 10px 0; cursor: pointer; font-weight: 600; color: #4b5bdc; display:flex; align-items:center; justify-content:space-between; }
    .accordion-content { display: none; padding: 6px 0 14px 0; }
    .accordion-header.open + .accordion-content { display: block; }

    .resources-section { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .resources-section h2 { color: #667eea; font-size: 1.8em; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
    .resources-section h3 { color: #764ba2; font-size: 1.3em; margin: 25px 0 15px 0; }
    .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .resource-card { background: linear-gradient(135deg, #f5f7ff 0%, #fff5f8 100%); border: 2px solid #e0e5ff; border-radius: 10px; padding: 15px; transition: all 0.3s; cursor: pointer; }
    .resource-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); border-color: #667eea; }
    .resource-card h4 { color: #667eea; font-size: 1.1em; margin-bottom: 8px; }
    .resource-card p { color: #555; font-size: 0.9em; line-height: 1.4; }
    .resource-link { color: #764ba2; text-decoration: none; font-weight: bold; font-size: 0.9em; display: inline-block; margin-top: 8px; }
    .resource-link:hover { text-decoration: underline; }

    @media (max-width: 768px) { h1 { font-size: 1.8em; } .events-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìÖ Critical Care Webinars</h1>
      <p class="subtitle">
        Semana del <strong>13 al 18 de Octubre 2025</strong> ¬∑ <span class="small-note">Horarios seg√∫n hora de Lima (GMT-5)</span>
      </p>
      <div class="intro">
  <strong>¬øQu√© es Critical Care Webinars?</strong><br>
  Agenda acad√©mica, viva y curada de <em>webinars, cursos y eventos</em> en medicina cr√≠tica, ECMO, simulaci√≥n cl√≠nica, seguridad del paciente e IA en salud. Integra la oferta formativa en un solo espacio y la presenta con conversi√≥n horaria a Lima (GMT-5).
  <br><strong>La semana pasada registramos 70 eventos</strong> y mantenemos una actualizaci√≥n continua: incorporamos nuevas sesiones verificadas con informaci√≥n estandarizada (t√≠tulo, instituci√≥n organizadora, √°rea tem√°tica y enlace de acceso).
</div>
    </header>

    <div id="loadingSection" class="loading">
      <div class="loading-spinner"></div>
      <p>Cargando eventos desde Google Sheets...</p>
    </div>

    <div id="errorSection" class="error" style="display:none;"></div>

    <div id="mainContent" style="display:none;">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="totalEvents">0</div>
          <div class="stat-label">Eventos Totales (Semana actual)</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="visibleEvents">0</div>
          <div class="stat-label">Eventos Visibles</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="futureEvents">0</div>
          <div class="stat-label">Eventos futuros (semana actual)</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="prevWeekEvents">70</div>
          <div class="stat-label">Eventos semana anterior</div>
        </div>
        <div class="stat-item">
          <button id="exportWeek" class="btn-secondary">üì• Exportar semana actual (.ics)</button>
          <div class="small-note" style="margin-top:6px">Crea un archivo para Google/Outlook</div>
        </div>
      </div>

      <!-- Acciones r√°pidas -->
      <div class="filter-actions">
        <button id="toggleTodayBtn" class="toggle-today">üü£ Solo HOY</button>
      </div>

      <div class="filters">
        <span class="filter-label">Filtrar por:</span>
        <select id="dayFilter"></select>
        <input type="text" id="searchFilter" placeholder="Buscar por tema, organizador o especialidad‚Ä¶">
        <button id="reloadBtn" class="btn-secondary">üîÑ Actualizar</button>
      </div>

      <div id="eventsContainer"></div>

      <!-- Archivo de semanas -->
      <div class="archive" id="archiveBlock" style="display:none;">
        <h2 style="color:#667eea; margin-bottom:8px;">üóÇÔ∏è Archivo de semanas</h2>
        <div class="accordion" id="archiveAccordion"></div>
      </div>

      <!-- Secci√≥n de Recursos -->
      <div class="resources-section">
        <h2>üìö Recursos para Intensivistas y Simulacionistas</h2>

        <!-- üéì CURSOS RECOMENDADOS -->
        <h3>üéì Cursos Recomendados</h3>
        <div class="resource-grid">
          <!-- NUEVO -->
          <div class="resource-card" onclick="window.open('https://getinge.training/lms/signin', '_blank')">
            <h4>Getinge Training LMS</h4>
            <p>Plataforma e-learning con m√≥dulos de ventilaci√≥n, ECMO, perfusi√≥n y manejo del paciente cr√≠tico.
              <strong>Requiere registro</strong> y los <strong>cursos son certificados</strong>.</p>
            <span class="resource-link">Ir a Getinge Training ‚Üí</span>
          </div>
          <!-- NUEVO -->
          <div class="resource-card" onclick="window.open('https://advancedrenaleducation.com/wparep/emea/elearning/critical-care/', '_blank')">
            <h4>AREP ‚Äì Critical Care (Advanced Renal Education Program)</h4>
            <p>M√≥dulos sobre TRRC, hemodi√°lisis en UCI, ultrafiltraci√≥n y soporte renal en el paciente cr√≠tico.
              <strong>Cursos certificados</strong>.</p>
            <span class="resource-link">Explorar AREP ‚Üí</span>
          </div>
          <!-- NUEVO -->
          <div class="resource-card" onclick="window.open('https://www.fluidacademy.org/', '_blank')">
            <h4>Fluid Academy ‚Äì Fluid Championship</h4>
            <p>Programa/retos sobre <em>fluid stewardship</em> y optimizaci√≥n de fluidoterapia en cr√≠ticos.
              <strong>Certificado</strong>.</p>
            <span class="resource-link">Fluid Academy ‚Üí</span>
          </div>

          <div class="resource-card" onclick="window.open('https://www.fccs.org/', '_blank')">
            <h4>FCCS (Fundamental Critical Care Support)</h4>
            <p>Curso fundamental de la SCCM para el manejo del paciente cr√≠tico.</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://www.atls.org/', '_blank')">
            <h4>ATLS (Advanced Trauma Life Support)</h4>
            <p>Manejo inicial del paciente traumatizado (American College of Surgeons).</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://acls.com/', '_blank')">
            <h4>ACLS (Advanced Cardiovascular Life Support)</h4>
            <p>Soporte vital cardiovascular avanzado (AHA).</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://www.sccm.org/Education-Center', '_blank')">
            <h4>SCCM Education Center</h4>
            <p>Plataforma educativa con cursos y webinars de la SCCM.</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>
        </div>

        <!-- üì± APPS ESENCIALES -->
        <h3>üì± Apps Esenciales para Intensivistas</h3>
        <div class="resource-grid">
          <div class="resource-card" onclick="window.open('https://apps.apple.com/app/epocrates/id281935788', '_blank')">
            <h4>Epocrates</h4>
            <p>F√°rmacos, interacciones y gu√≠as. iOS/Android.</p>
            <span class="resource-link">Descargar ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://www.mdcalc.com/', '_blank')">
            <h4>MDCalc</h4>
            <p>Calculadoras cl√≠nicas (APACHE II, SOFA, Glasgow, etc.).</p>
            <span class="resource-link">Visitar sitio ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://reference.medscape.com/', '_blank')">
            <h4>Medscape</h4>
            <p>Referencia cl√≠nica y noticias.</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://apps.apple.com/app/uptodate/id334265345', '_blank')">
            <h4>UpToDate</h4>
            <p>Revisi√≥n basada en evidencia (requiere suscripci√≥n).</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>

          <!-- NUEVO -->
          <div class="resource-card">
            <h4>CSWG App</h4>
            <p>Gu√≠as r√°pidas y apoyo a la toma de decisiones en cuidados cr√≠ticos.</p>
            <p>
              <a class="resource-link" href="https://apps.apple.com/us/search?term=CSWG" target="_blank" rel="noopener">iOS (b√∫squeda) ‚Üí</a>
              &nbsp;|&nbsp;
              <a class="resource-link" href="https://play.google.com/store/search?q=CSWG&c=apps" target="_blank" rel="noopener">Android (b√∫squeda) ‚Üí</a>
            </p>
          </div>
          <!-- NUEVO -->
          <div class="resource-card">
            <h4>ALMAS LATAM App</h4>
            <p>Recursos, eventos y comunidad de simulaci√≥n/educaci√≥n m√©dica en LATAM.</p>
            <p>
              <a class="resource-link" href="https://apps.apple.com/us/search?term=ALMAS%20LATAM" target="_blank" rel="noopener">iOS (b√∫squeda) ‚Üí</a>
              &nbsp;|&nbsp;
              <a class="resource-link" href="https://play.google.com/store/search?q=ALMAS%20LATAM&c=apps" target="_blank" rel="noopener">Android (b√∫squeda) ‚Üí</a>
            </p>
          </div>
          <!-- NUEVO -->
          <div class="resource-card">
            <h4>ELSO Bedside Guide</h4>
            <p>Gu√≠a de ECMO al pie de cama por ELSO.</p>
            <p>
              <a class="resource-link" href="https://apps.apple.com/us/search?term=ELSO%20Bedside%20Guide" target="_blank" rel="noopener">iOS (b√∫squeda) ‚Üí</a>
              &nbsp;|&nbsp;
              <a class="resource-link" href="https://play.google.com/store/search?q=ELSO%20Bedside%20Guide&c=apps" target="_blank" rel="noopener">Android (b√∫squeda) ‚Üí</a>
            </p>
          </div>
        </div>

        <!-- üéÆ APPS DE SIMULACI√ìN -->
        <h3>üéÆ Apps de Simulaci√≥n Cl√≠nica</h3>
        <div class="resource-grid">
          <div class="resource-card" onclick="window.open('https://www.laerdal.com/simpad/', '_blank')">
            <h4>SimPad PLUS</h4>
            <p>Control inal√°mbrico de simuladores Laerdal para escenarios de alta fidelidad.</p>
            <span class="resource-link">M√°s informaci√≥n ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://www.resusroom.com/', '_blank')">
            <h4>Resus Room</h4>
            <p>Simulador de reanimaci√≥n interactivo.</p>
            <span class="resource-link">Probar ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://apps.apple.com/app/full-code-pro/id456863476', '_blank')">
            <h4>Full Code Pro</h4>
            <p>Simulador de c√≥digos (ACLS/PALS) con escenarios realistas.</p>
            <span class="resource-link">Descargar ‚Üí</span>
          </div>
          <div class="resource-card" onclick="window.open('https://www.heartsim.com/', '_blank')">
            <h4>HeartSim</h4>
            <p>Simulador de ECG para ritmos card√≠acos.</p>
            <span class="resource-link">Visitar ‚Üí</span>
          </div>

          <!-- NUEVO -->
          <div class="resource-card">
            <h4>AED Sim</h4>
            <p>Entrenamiento en desfibrilaci√≥n y uso de DEA con escenarios guiados.</p>
            <p>
              <a class="resource-link" href="https://apps.apple.com/us/search?term=AED%20Sim" target="_blank" rel="noopener">iOS (b√∫squeda) ‚Üí</a>
              &nbsp;|&nbsp;
              <a class="resource-link" href="https://play.google.com/store/search?q=AED%20Sim&c=apps" target="_blank" rel="noopener">Android (b√∫squeda) ‚Üí</a>
            </p>
          </div>
          <!-- NUEVO -->
          <div class="resource-card">
            <h4>DARTSim Remote</h4>
            <p>Control remoto de escenarios y monitor para entrenamiento de equipo.</p>
            <p>
              <a class="resource-link" href="https://apps.apple.com/us/search?term=DARTSim%20Remote" target="_blank" rel="noopener">iOS (b√∫squeda) ‚Üí</a>
              &nbsp;|&nbsp;
              <a class="resource-link" href="https://play.google.com/store/search?q=DARTSim%20Remote&c=apps" target="_blank" rel="noopener">Android (b√∫squeda) ‚Üí</a>
            </p>
          </div>
          <!-- NUEVO -->
          <div class="resource-card">
            <h4>AirwayEx</h4>
            <p>Simulaci√≥n de v√≠a a√©rea con casos progresivos y retroalimentaci√≥n.</p>
            <p>
              <a class="resource-link" href="https://apps.apple.com/us/search?term=AirwayEx" target="_blank" rel="noopener">iOS (b√∫squeda) ‚Üí</a>
              &nbsp;|&nbsp;
              <a class="resource-link" href="https://play.google.com/store/search?q=AirwayEx&c=apps" target="_blank" rel="noopener">Android (b√∫squeda) ‚Üí</a>
            </p>
          </div>
        </div>
      </div>
      <!-- /Secci√≥n de Recursos -->
    </div>
  </div>

  <script>
    // ==============================
    // CONFIG
    // ==============================
    const BASE_SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgscb3CQReXXkS1S7Sgj_e-COWBuQ38YO-eJ9Cr3wOvV8MCPGFt-s-01KLNkCpi00zqFnMvMsL4zTi/pub?gid=0&single=true&output=csv';

    // GIDs confirmados
    const GID_HOJA_2 = '626775764'; // Semana 2 (13‚Äì18 oct 2025)
    const GID_HOJA_1 = '0';         // Semana 1 (6‚Äì11 oct 2025)

    const WEEKS = [
      {
        key: 'current',
        label: 'Semana 13‚Äì18 de Octubre 2025',
        gid: GID_HOJA_2,
        start: '2025-10-13',
        end:   '2025-10-18',
        dayNames: {
          '2025-10-13': 'Lunes 13 de Octubre',
          '2025-10-14': 'Martes 14 de Octubre',
          '2025-10-15': 'Mi√©rcoles 15 de Octubre',
          '2025-10-16': 'Jueves 16 de Octubre',
          '2025-10-17': 'Viernes 17 de Octubre',
          '2025-10-18': 'S√°bado 18 de Octubre'
        }
      },
      {
        key: 'prev',
        label: 'Semana 6‚Äì11 de Octubre 2025',
        gid: GID_HOJA_1,
        start: '2025-10-06',
        end:   '2025-10-11',
        dayNames: {
          '2025-10-06': 'Lunes 6 de Octubre',
          '2025-10-07': 'Martes 7 de Octubre',
          '2025-10-08': 'Mi√©rcoles 8 de Octubre',
          '2025-10-09': 'Jueves 9 de Octubre',
          '2025-10-10': 'Viernes 10 de Octubre',
          '2025-10-11': 'S√°bado 11 de Octubre'
        }
      }
    ];
    const buildSheetUrl = (gid) => BASE_SHEET_CSV.replace(/gid=\d+/, `gid=${gid}`);

    // ==============================
    // STATE
    // ==============================
    let events = [];           // semana actual
    let allDates = new Set();  // semana actual
    let archive = {};          // {weekKey: {flat:[], byDay:{}}}
    let showTodayOnly = true;  // arranca en "Solo HOY"

    // ==============================
    // CSV + TIME HELPERS
    // ==============================
    function normalizeDate(x){ if(!x) return ""; const s=String(x).trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/); if(m){let[,d,mo,y]=m; if(y.length===2) y=(Number(y)>50?"19":"20")+y; return `${y.padStart(4,"0")}-${mo.padStart(2,"0")}-${d.padStart(2,"0")}`;} return ""; }
    function normalizeTime(x){ if(x===null||x===undefined) return ""; let s=String(x).trim().toLowerCase(); s=s.replace(/\s*[ap]\.?m\.?$/,"");
      if(/^\d{1,2}:\d{2}$/.test(s)){const[h,m]=s.split(":"); return `${h.padStart(2,"0")}:${m}`;} if(/^\d{1,2}$/.test(s)) return `${s.padStart(2,"0")}:00`;
      const f=parseFloat(s.replace(",", ".")); if(!isNaN(f)){const h=Math.floor(f), m=Math.round((f-h)*60); return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`; }
      return ""; }
    function getField(row, keys){ for(const k of keys){ if(row[k]!==undefined && String(row[k]).trim()!=="") return String(row[k]).trim(); } return ""; }
    function parseCSV(csv){
      const result = Papa.parse(csv,{header:true,skipEmptyLines:"greedy",transformHeader:h=>String(h).trim().toLowerCase()});
      const rows=[]; for(const row of result.data){
        const date=normalizeDate(getField(row,["date","fecha","d√≠a","dia"]));
        const time=normalizeTime(getField(row,["time","hora","start","inicio"]));
        const title=getField(row,["title","t√≠tulo","titulo","tema","subject"]);
        const link=getField(row,["link","enlace","url"]);
        const organizer=getField(row,["organizer","organizador","host","org","institucion","instituci√≥n"]);
        const category=getField(row,["category","categor√≠a","categoria","especialidad"]);
        if(date&&time&&title){ rows.push({date,time,title,link,organizer,category}); }
      } return rows;
    }
    function withinRange(d,s,e){ return d>=s && d<=e; }
    function nowInLimaDate(){ return new Date(new Date().toLocaleString('en-US',{timeZone:'America/Lima'})); }
    function todayStrLima(){ return nowInLimaDate().toISOString().split('T')[0]; }

    // ==============================
    // RENDER ‚Äì Semana actual
    // ==============================
    function updateDateFilter(dayNames){
      const select=document.getElementById('dayFilter');
      select.innerHTML='';
      const optAll=document.createElement('option'); optAll.value='all'; optAll.textContent='Todos los d√≠as'; select.appendChild(optAll);
      Array.from(allDates).sort().forEach(date=>{
        const option=document.createElement('option'); option.value=date; option.textContent=dayNames[date]||date; select.appendChild(option);
      });
    }

    function renderEvents(filteredEvents, dayNames){
      const container=document.getElementById('eventsContainer'); container.innerHTML='';
      if(filteredEvents.length===0){ container.innerHTML='<div class="loading"><p>No se encontraron eventos</p></div>'; document.getElementById('visibleEvents').textContent='0'; return; }

      const eventsByDay={}; filteredEvents.forEach(ev=>{ (eventsByDay[ev.date] ||= []).push(ev); });
      const todayStr=todayStrLima();

      Object.keys(eventsByDay).sort().forEach(date=>{
        const isPast = date < todayStr;
        const isToday = date === todayStr;
        const daySection=document.createElement('div'); daySection.className='day-section';
        const count=eventsByDay[date].length;

        const dayHeader=document.createElement('div');
        dayHeader.className=`day-header ${isPast?'past':''} ${isToday?'today':''}`;
        const shouldCollapse=!isToday; if(shouldCollapse) dayHeader.classList.add('collapsed');
        dayHeader.innerHTML=`
          <div style="display:flex; align-items:center;">
            <div class="day-title">${(dayNames[date]||date)} <span style="color:#999; font-weight:600;">(${count})</span></div>
            ${isToday ? '<span class="today-badge">üìç HOY</span>' : ''}
          </div>
          <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-secondary" data-day="${date}" onclick="event.stopPropagation()">üì• Exportar d√≠a (.ics)</button>
            <span class="collapse-icon">${shouldCollapse ? '‚ñ∂' : '‚ñº'}</span>
          </div>
        `;

        const dayContent=document.createElement('div');
        dayContent.className=`day-content ${shouldCollapse?'collapsed':''}`;
        if(shouldCollapse) dayContent.style.maxHeight='0';

        dayHeader.addEventListener('click',(e)=>{
          if(e.target.tagName==='BUTTON') return;
          dayContent.classList.toggle('collapsed'); dayHeader.classList.toggle('collapsed');
          if(dayContent.classList.contains('collapsed')){ dayContent.style.maxHeight='0'; }
          else{ dayContent.style.maxHeight=dayContent.scrollHeight+'px'; }
        });

        const eventsGrid=document.createElement('div'); eventsGrid.className='events-grid';
        eventsByDay[date].forEach(event=>{
          const card=document.createElement('div'); card.className='event-card';
          card.innerHTML=`
            <div class="category-tag">${event.category||'General'}</div>
            <div class="event-time">üïê ${event.time}</div>
            <div class="event-title">${event.title}</div>
            <div class="event-organizer">üìç ${event.organizer||'‚Äî'}</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              ${event.link ? `<a href="${event.link}" target="_blank" rel="noopener noreferrer" class="event-link">Unirse al evento ‚Üí</a>` : ''}
              <button class="ics-btn" data-ics="${event.date}__${event.time}__${(event.title||'').replace(/\s+/g,'_')}">.ics</button>
            </div>
          `;
          eventsGrid.appendChild(card);
        });

        dayContent.appendChild(eventsGrid);
        daySection.appendChild(dayHeader);
        daySection.appendChild(dayContent);
        container.appendChild(daySection);
      });

      document.getElementById('visibleEvents').textContent=String(filteredEvents.length);

      document.querySelectorAll('[data-day]').forEach(btn=>{
        btn.onclick=()=>exportICS(filteredEvents.filter(e=>e.date===btn.dataset.day),`eventos-${btn.dataset.day}.ics`);
      });
      document.querySelectorAll('[data-ics]').forEach(btn=>{
        btn.onclick=()=>{
          const [d,t]=btn.dataset.ics.split('__');
          const ev=filteredEvents.find(e=>e.date===d && e.time===t);
          if(ev) exportICS([ev], `evento-${d}-${t.replace(':','')}.ics`);
        };
      });
    }

    // ==============================
    // ARCHIVO ‚Äì Semana anterior
    // ==============================
    function renderArchive(weekKey){
  const acc = document.getElementById('archiveAccordion');
  const data = archive[weekKey];
  const week = WEEKS.find(w => w.key === weekKey);
  if (!data || !week) return;

  const total = data.flat.length;
  if (weekKey === 'prev') {
    document.getElementById('prevWeekEvents').textContent = String(total || 70);
  }

  const header = document.createElement('button');
  header.className = 'accordion-header'; // inicia cerrado
  header.textContent = `${week.label} ¬∑ total ${total} eventos`;

  const content = document.createElement('div');
  content.className = 'accordion-content';
  content.style.display = 'none'; // oculto por defecto

  const exportBtn = document.createElement('button');
  exportBtn.className = 'btn-secondary';
  exportBtn.style.margin = '6px 0 12px 0';
  exportBtn.textContent = 'üì• Exportar semana (.ics)';
  exportBtn.onclick = () => exportICS(data.flat, `eventos_${week.label.replace(/\s+/g,'_')}.ics`);
  content.appendChild(exportBtn);

  Object.keys(data.byDay).sort().forEach(date => {
    const list = data.byDay[date];
    const wrap = document.createElement('div');
    wrap.className = 'day-section';

    const dayHeader = document.createElement('div');
    dayHeader.className = 'day-header';
    dayHeader.innerHTML = `
      <div class="day-title">${(week.dayNames[date] || date)} <span style="color:#999; font-weight:600;">(${list.length})</span></div>
      <button class="btn-secondary" data-archived-day="${weekKey}__${date}">üì• Exportar d√≠a (.ics)</button>
    `;
    wrap.appendChild(dayHeader);

    const grid = document.createElement('div');
    grid.className = 'events-grid';
    list.forEach(ev => {
      const card = document.createElement('div');
      card.className = 'event-card';
      card.innerHTML = `
        <div class="category-tag">${ev.category || 'General'}</div>
        <div class="event-time">üïê ${ev.time}</div>
        <div class="event-title">${ev.title}</div>
        <div class="event-organizer">üìç ${ev.organizer || '‚Äî'}</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          ${ev.link ? `<a href="${ev.link}" target="_blank" rel="noopener noreferrer" class="event-link">Unirse al evento ‚Üí</a>` : ''}
          <button class="ics-btn" data-archived-ics="${weekKey}__${ev.date}__${ev.time}">.ics</button>
        </div>
      `;
      grid.appendChild(card);
    });

    wrap.appendChild(grid);
    content.appendChild(wrap);
  });

  const block = document.createElement('div');
  block.className = 'accordion-item';
  block.appendChild(header);
  block.appendChild(content);
  acc.appendChild(block);

  // üîΩ Toggle: abre o cierra el bloque al hacer clic
  header.onclick = () => {
    const isOpen = header.classList.toggle('open');
    content.style.display = isOpen ? 'block' : 'none';
  };

  // Exportadores individuales
  content.querySelectorAll('[data-archived-day]').forEach(btn => {
    btn.onclick = () => {
      const [, date] = btn.dataset.archivedDay.split('__');
      exportICS(archive[weekKey].byDay[date], `eventos-${date}.ics`);
    };
  });
  content.querySelectorAll('[data-archived-ics]').forEach(btn => {
    btn.onclick = () => {
      const [, d, t] = btn.dataset.archivedIcs.split('__');
      const ev = archive[weekKey].flat.find(e => e.date === d && e.time === t);
      if (ev) exportICS([ev], `evento-${d}-${t.replace(':', '')}.ics`);
    };
  });
}


    // ==============================
    // FILTROS ‚Äì Semana actual
    // ==============================
    function filterEvents(dayNames){
      const select=document.getElementById('dayFilter');
      const search=(document.getElementById('searchFilter').value||'').toLowerCase();
      let selectedDay=select.value;

      if(showTodayOnly){
        const t=todayStrLima();
        if(allDates.has(t)){ selectedDay=t; select.value=t; }
        else{ selectedDay='all'; select.value='all'; }
      }

      const out=events.filter(ev=>{
        const okDay=(selectedDay==='all') || ev.date===selectedDay;
        const hay=[ev.title, ev.organizer, ev.category].filter(Boolean).join(' ').toLowerCase();
        const okSearch=!search || hay.includes(search);
        return okDay && okSearch;
      });

      renderEvents(out, dayNames);
    }

    // ==============================
    // ICS
    // ==============================
    function toICS(list){
      const lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Critical Care Webinars//Jhan//ES"];
      const now=new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z/,"Z");
      for(const ev of list){
        const [h,m]=(ev.time||"00:00").split(':').map(n=>parseInt(n||"0",10));
        const [Y,Mo,D]=ev.date.split('-').map(n=>parseInt(n,10));
        const start=new Date(Y,(Mo-1),D,h,m,0);
        const end=new Date(start.getTime()+60*60*1000);
        const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z/,"Z");
        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${Y}${String(Mo).padStart(2,'0')}${String(D).padStart(2,'0')}-${String(h).padStart(2,'0')}${String(m).padStart(2,'0')}@ccw`);
        lines.push(`DTSTAMP:${now}`);
        lines.push(`DTSTART:${fmt(start)}`);
        lines.push(`DTEND:${fmt(end)}`);
        lines.push(`SUMMARY:${(ev.title||'Evento').replace(/[\r\n,]/g,' ')}`);
        lines.push(`DESCRIPTION:${[(ev.organizer||''),(ev.category||'')].filter(Boolean).join(' | ').replace(/[\r\n,]/g,' ')}`);
        if(ev.link) lines.push(`URL:${ev.link}`);
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }
    function exportICS(list, filename){
      const blob=new Blob([toICS(list)], {type:"text/calendar"});
      const url=URL.createObjectURL(blob);
      const a=Object.assign(document.createElement("a"),{href:url,download:filename});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ==============================
    // LOAD
    // ==============================
    async function loadWeek(week){
      const res=await fetch(buildSheetUrl(week.gid), {cache:"no-store"});
      if(!res.ok) throw new Error(`No se pudo cargar el CSV de ${week.label}`);
      const csv=await res.text();
      return parseCSV(csv)
        .filter(e=>withinRange(e.date, week.start, week.end))
        .sort((a,b)=>a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
    }

    function nowInLimaDate(){ return new Date(new Date().toLocaleString('en-US',{timeZone:'America/Lima'})); }
    function updateFutureCounter(){
      const nowLima=nowInLimaDate();
      const count=events.reduce((acc,e)=>{
        const [Y,Mo,D]=e.date.split('-').map(Number);
        const [h,m]=(e.time||'00:00').split(':').map(n=>parseInt(n||'0',10));
        const dt=new Date(Y,Mo-1,D,h,m,0);
        return acc + (dt >= nowLima ? 1 : 0);
      },0);
      document.getElementById('futureEvents').textContent=String(count);
    }

    async function loadAll(){
      const $loading=document.getElementById('loadingSection');
      const $error=document.getElementById('errorSection');
      const $main=document.getElementById('mainContent');

      $loading.style.display='block'; $error.style.display='none'; $main.style.display='none';

      try{
        const [currentList, prevList]=await Promise.all([
          loadWeek(WEEKS.find(w=>w.key==='current')),
          loadWeek(WEEKS.find(w=>w.key==='prev'))
        ]);

        // Semana actual
        events.length=0; allDates.clear();
        currentList.forEach(e=>{ events.push(e); allDates.add(e.date); });
        document.getElementById('totalEvents').textContent=String(events.length);
        updateDateFilter(WEEKS.find(w=>w.key==='current').dayNames);

        // Auto-activar "Solo HOY" si hoy existe en la semana
        const t=todayStrLima();
        const toggleBtn=document.getElementById('toggleTodayBtn');
        if(allDates.has(t)){ showTodayOnly=true; toggleBtn.classList.add('active'); toggleBtn.textContent='‚Ü©Ô∏è Ver todos'; }
        else{ showTodayOnly=false; toggleBtn.classList.remove('active'); toggleBtn.textContent='üü£ Solo HOY'; }

        updateFutureCounter();
        filterEvents(WEEKS.find(w=>w.key==='current').dayNames);

        // Archivo semana previa
        const prev=WEEKS.find(w=>w.key==='prev');
        archive['prev']={ flat: prevList.slice(), byDay: prevList.reduce((acc,ev)=>{ (acc[ev.date] ||= []).push(ev); return acc; },{}) };
        const hasArchive=archive['prev'].flat.length>0;
        document.getElementById('archiveBlock').style.display=hasArchive?'block':'none';
        if(hasArchive){ const acc=document.getElementById('archiveAccordion'); acc.innerHTML=''; renderArchive('prev'); }

        $loading.style.display='none'; $main.style.display='block';
      }catch(err){
        console.error(err);
        $loading.style.display='none'; $error.style.display='block';
        $error.innerHTML=`
          <strong>‚ö†Ô∏è Error al cargar eventos</strong><br>
          ${err.message}<br><br>
          Verifica que:<br>
          ‚Ä¢ Ambas hojas est√©n <em>Publicadas en la web</em> como CSV<br>
          ‚Ä¢ Est√©s usando el <code>gid</code> correcto de la <b>Hoja 1 (6‚Äì11)</b> y <b>Hoja 2 (13‚Äì18)</b><br><br>
          <button class="btn-secondary" id="retryBtn">Reintentar</button>
        `;
        document.getElementById('retryBtn').onclick=loadAll;
      }
    }

    // ==============================
    // INIT + LISTENERS
    // ==============================
    document.getElementById('reloadBtn').onclick=()=>{ loadAll(); };
    document.getElementById('searchFilter').oninput=()=>filterEvents(WEEKS.find(w=>w.key==='current').dayNames);
    document.getElementById('dayFilter').onchange=()=>{
      // si el usuario cambia el selector, desactivamos "Solo HOY"
      showTodayOnly=false;
      const btn=document.getElementById('toggleTodayBtn');
      btn.classList.remove('active'); btn.textContent='üü£ Solo HOY';
      filterEvents(WEEKS.find(w=>w.key==='current').dayNames);
    };
    document.getElementById('exportWeek').onclick=()=>exportICS(events, 'eventos-semana-actual.ics');

    // Toggle "Solo HOY"
    document.getElementById('toggleTodayBtn').onclick=()=>{
      showTodayOnly=!showTodayOnly;
      const btn=document.getElementById('toggleTodayBtn');
      if(showTodayOnly){ btn.classList.add('active'); btn.textContent='‚Ü©Ô∏è Ver todos'; }
      else{ btn.classList.remove('active'); btn.textContent='üü£ Solo HOY'; document.getElementById('dayFilter').value='all'; }
      filterEvents(WEEKS.find(w=>w.key==='current').dayNames);
    };

    // Carga inicial + auto-refresh
    loadAll();
    setInterval(()=>{ loadAll(); }, 300000);
    setInterval(()=>{ updateFutureCounter(); }, 60000);
  </script>
</body>
</html>
