<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Critical Care Webinars</title>

  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WKDR4C816"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1WKDR4C816');
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #111;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header {
      background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 1.1em; }
    .intro { margin-top: 14px; color: #333; line-height: 1.5; font-size: 0.98em; background: #f8f8ff; border: 1px solid rgba(102,126,234,.25); padding: 12px 14px; border-radius: 10px; }

    .loading { background: white; border-radius: 15px; padding: 40px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
    .error { background: #ffe6e6; border: 2px solid #ff4444; border-radius: 10px; padding: 20px; margin-bottom: 30px; color: #cc0000; }

    .filters { background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
    .filter-actions { display:flex; gap:12px; align-items:center; margin-bottom: 10px; }
    .filter-label { font-weight: bold; color: #667eea; }
    select, input[type="text"] { padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; outline: none; transition: all 0.3s; background: #fff; }
    select:focus, input[type="text"]:focus { border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .toggle-today { background: #fff; color: #764ba2; border: 2px solid #764ba2; padding: 8px 14px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all .2s; }
    .toggle-today.active { background: #764ba2; color:#fff; }

    .day-section { margin-bottom: 30px; }
    .day-header { background: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; transition: all 0.3s; }
    .day-header:hover { background: #f8f9ff; }
    .day-header.past { opacity: 0.6; }
    .day-header.today { background: linear-gradient(135deg, #fff5e6 0%, #ffe6f0 100%); border: 2px solid #667eea; }
    .today-badge { background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: bold; margin-left: 10px; }
    .collapse-icon { font-size: 1.2em; transition: transform 0.3s; }
    .collapsed .collapse-icon { transform: rotate(-90deg); }
    .day-content { overflow: hidden; transition: max-height 0.3s ease-out; }
    .day-content.collapsed { max-height: 0 !important; }
    .day-title { color: #667eea; font-size: 1.5em; font-weight: bold; }
    .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .event-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; border-left: 5px solid #667eea; }
    .event-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .event-time { color: #764ba2; font-weight: bold; font-size: 1.1em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .event-title { color: #333; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; line-height: 1.4; }
    .event-organizer { color: #666; font-size: 0.9em; margin-bottom: 15px; font-style: italic; }
    .event-link, .ics-btn { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s; border: none; cursor: pointer; }
    .event-link:hover, .ics-btn:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
    .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all .3s; }
    .btn-secondary:hover { background: #667eea; color: #fff; }
    .category-tag { display: inline-block; background: #f0f0f0; color: #667eea; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; margin-bottom: 10px; font-weight: 600; }

    .stats { background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
    .stat-item { text-align: center; }
    .stat-number { font-size: 2.5em; color: #667eea; font-weight: bold; }
    .stat-label { color: #666; font-size: 1em; }
    .small-note { font-size: .85em; color:#555; }

    .archive { background: white; border-radius: 15px; padding: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 24px; }
    .accordion { border-top: 1px solid #eee; margin-top: 10px; }
    .accordion-item { border-bottom: 1px solid #eee; }
    .accordion-header { width: 100%; text-align: left; background: #f9f9ff; border: 1px solid rgba(102,126,234,.25); padding: 12px 14px; border-radius: 10px; margin: 10px 0; cursor: pointer; font-weight: 600; color: #4b5bdc; display:flex; align-items:center; justify-content:space-between; }
    .accordion-content { display: none; padding: 6px 0 14px 0; }
    .accordion-header.open + .accordion-content { display: block; }

    .resources-section { background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .resources-section h2 { color: #667eea; font-size: 1.8em; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
    .resources-section h3 { color: #764ba2; font-size: 1.3em; margin: 25px 0 15px 0; }
    .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .resource-card { background: linear-gradient(135deg, #f5f7ff 0%, #fff5f8 100%); border: 2px solid #e0e5ff; border-radius: 10px; padding: 15px; transition: all 0.3s; cursor: pointer; }
    .resource-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); border-color: #667eea; }
    .resource-card h4 { color: #667eea; font-size: 1.1em; margin-bottom: 8px; }
    .resource-card p { color: #555; font-size: 0.9em; line-height: 1.4; }
    .resource-link { color: #764ba2; text-decoration: none; font-weight: bold; font-size: 0.9em; display: inline-block; margin-top: 8px; }
    .resource-link:hover { text-decoration: underline; }

    .featured-gold{
      border: 3px solid #ffd700 !important;
      background: linear-gradient(135deg,#fffbe6 0%, #fff9d9 100%) !important;
      position: relative;
    }
    .featured-gold .featured-badge{
      background: #d4af37;
      color: #000;
      font-weight: 800;
      font-size: 0.75rem;
      letter-spacing: .5px;
      padding: 3px 8px;
      border-radius: 999px;
      box-shadow: 0 2px 8px rgba(212,175,55,.25);
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .featured-gold .resource-cta{
      background: linear-gradient(135deg,#ffe066 0%, #ffcc00 100%);
      color: #000;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(212,175,55,.25);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .featured-gold .resource-cta:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(212,175,55,.35);
    }

    .event-card.certified {
      background: #f3fbf6;
      border-left-color: #84d8a7;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      margin-left: 8px;
    }
    .badge-cert {
      background: #e9f8ef;
      border-color: #bfead0;
      color: #146c43;
    }
    .badge-lang {
      background: #eef1ff;
      border-color: #cfd7ff;
      color: #4b5bdc;
      margin-left: 0;
    }

    .weekly-update {
      margin-top: 14px;
      padding: 16px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    .weekly-update h3 {
      color: #667eea;
      margin-bottom: 10px;
    }
    .weekly-update p {
      color: #333;
      line-height: 1.6;
    }

    @media (max-width: 768px) { h1 { font-size: 1.8em; } .events-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìÖ Critical Care Webinars</h1>
      <p class="subtitle">
        Week of <strong>October 26 ‚Äì November 1, 2025</strong> ¬∑ <span class="small-note">Times shown in Lima (GMT-5)</span>
      </p>

      <div class="intro">
        <div class="weekly-update featured-gold">
          <h3>üåé Week of Oct 26 ‚Äì Nov 1</h3>
          <p>
            <strong>Critical Care Webinars</strong> has reached professionals in <strong>80+ countries</strong> and has featured
            <strong>300+ webinars</strong> over the weeks. We remain committed to a reliable, high-quality academic option for everyone.
          </p>
        </div>

        <strong>What is Critical Care Webinars?</strong><br>
        Academic, living, and curated agenda of <em>webinars, courses, and events</em> in critical care, ECMO, clinical simulation, patient safety, and AI in healthcare. It consolidates learning opportunities in one place and presents them with time-zone conversion to Lima (GMT-5).
        <br><strong>Last week we recorded more than 100 events</strong> and we continuously update the agenda by incorporating new, verified sessions with standardized information (title, organizing institution, thematic area, and access link).
      </div>
    </header>

    <div id="loadingSection" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading events‚Ä¶</p>
    </div>

    <div id="errorSection" class="error" style="display:none;"></div>

    <div id="mainContent" style="display:none;">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="totalEvents">0</div>
          <div class="stat-label">Total events (current week)</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="visibleEvents">0</div>
          <div class="stat-label">Visible events</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="futureEvents">0</div>
          <div class="stat-label">Upcoming events (current week)</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="prevWeekEvents">70</div>
          <div class="stat-label">Events last week</div>
        </div>
        <div class="stat-item">
          <button id="exportWeek" class="btn-secondary">üì• Export current week (.ics)</button>
          <div class="small-note" style="margin-top:6px">Import into Google/Outlook</div>
        </div>
      </div>

      <div class="filter-actions">
        <button id="toggleTodayBtn" class="toggle-today">üü£ Today only</button>
      </div>

      <div class="filters">
        <span class="filter-label">Filter:</span>
        <select id="dayFilter"></select>
        <select id="langFilter" title="Language">
          <option value="__ALL__">All languages</option>
        </select>
        <input type="text" id="searchFilter" placeholder="Search by topic, organizer, or specialty‚Ä¶">
        <button id="reloadBtn" class="btn-secondary">üîÑ Refresh</button>
      </div>

      <div id="eventsContainer"></div>

      <div class="archive" id="archiveBlock" style="display:none;">
        <h2 style="color:#667eea; margin-bottom:8px;">üóÇÔ∏è Weeks archive</h2>
        <div class="accordion" id="archiveAccordion"></div>
      </div>

      <div class="resources-section">
        <h2>üìö Resources for Intensivists & Simulationists</h2>
        <h3>üéì Recommended Courses</h3>
        <div class="resource-grid">
          <div class="resource-card featured-gold"
               onclick="window.open('https://lnkd.in/ePXZUYVr', '_blank')">
            <div class="featured-badge">FEATURED</div>
            <h4>ü©∫ Competencias Docentes para el entorno cl√≠nico de aprendizaje</h4>
            <ul style="margin:8px 0 10px 18px; color:#333; font-size:0.95em; line-height:1.4;">
              <li><strong>Dise√±ado por:</strong> Dr. Ismael David Piedra</li>
              <li><strong>Modalidad:</strong> Autogestiva</li>
              <li><strong>Organiza:</strong> AMFEM</li>
            </ul>
            <button class="resource-cta">¬°REG√çSTRATE AHORA!</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgscb3CQReXXkS1S7Sgj_e-COWBuQ38YO-eJ9Cr3wOvV8MCPGFt-s-01KLNkCpi00zqFnMvMsL4zTi/pub?gid=0&single=true&output=csv';
    const GID_SHEET_3 = '248417399';
    const GID_SHEET_4 = '1475156769';

    const WEEKS = [
      {
        key: 'current',
        label: 'Week Oct 26 ‚Äì Nov 1, 2025',
        gid: GID_SHEET_4,
        start: '2025-10-26',
        end: '2025-11-01',
        dayNames: {
          '2025-10-26': 'Sunday, Oct 26',
          '2025-10-27': 'Monday, Oct 27',
          '2025-10-28': 'Tuesday, Oct 28',
          '2025-10-29': 'Wednesday, Oct 29',
          '2025-10-30': 'Thursday, Oct 30',
          '2025-10-31': 'Friday, Oct 31',
          '2025-11-01': 'Saturday, Nov 1'
        }
      },
      {
        key: 'prev',
        label: 'Week Oct 20‚Äì25, 2025',
        gid: GID_SHEET_3,
        start: '2025-10-20',
        end: '2025-10-25',
        dayNames: {
          '2025-10-20': 'Monday, Oct 20',
          '2025-10-21': 'Tuesday, Oct 21',
          '2025-10-22': 'Wednesday, Oct 22',
          '2025-10-23': 'Thursday, Oct 23',
          '2025-10-24': 'Friday, Oct 24',
          '2025-10-25': 'Saturday, Oct 25'
        }
      }
    ];

    const buildSheetUrl = (gid) => BASE_SHEET_CSV.replace(/gid=\d+/, `gid=${gid}`);

    let events = [];
    let allDates = new Set();
    let archive = {};
    let showTodayOnly = true;

    function normalizeDate(x) {
      if (!x) return "";
      const s = String(x).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        let [, d, mo, y] = m;
        if (y.length === 2) y = (Number(y) > 50 ? "19" : "20") + y;
        return `${y.padStart(4, "0")}-${mo.padStart(2, "0")}-${d.padStart(2, "0")}`;
      }
      return "";
    }

    function normalizeTime(x) {
      if (x === null || x === undefined) return "";
      let s = String(x).trim().toLowerCase();
      s = s.replace(/\s*[ap]\.?m\.?$/, "");
      if (/^\d{1,2}:\d{2}$/.test(s)) {
        const [h, m] = s.split(":");
        return `${h.padStart(2, "0")}:${m}`;
      }
      if (/^\d{1,2}$/.test(s)) return `${s.padStart(2, "0")}:00`;
      const f = parseFloat(s.replace(",", "."));
      if (!isNaN(f)) {
        const h = Math.floor(f), m = Math.round((f - h) * 60);
        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
      }
      return "";
    }

    function getField(row, keys) {
      for (const k of keys) {
        if (row[k] !== undefined && String(row[k]).trim() !== "") return String(row[k]).trim();
      }
      return "";
    }

    function parseCSV(csv) {
      if (typeof Papa === 'undefined') {
        throw new Error('PapaParse library not loaded');
      }
      
      const result = Papa.parse(csv, {
        header: true,
        skipEmptyLines: "greedy",
        transformHeader: h => String(h).trim().toLowerCase()
      });

      const rows = [];
      for (const row of result.data) {
        const date = normalizeDate(getField(row, ["date", "fecha", "d√≠a", "dia"]));
        const time = normalizeTime(getField(row, ["time", "hora", "start", "inicio"]));
        const title = getField(row, ["title", "t√≠tulo", "titulo", "tema", "subject"]);
        const link = getField(row, ["link", "enlace", "url"]);
        const organizer = getField(row, ["organizer", "organizador", "host", "org", "institucion", "instituci√≥n"]);
        const category = getField(row, ["category", "categor√≠a", "categoria", "especialidad"]);
        const language = getField(row, ["language", "idioma", "lang"]);
        const certificate = getField(row, ["certificate", "certificado", "cert"]);

        if (date && time && title) {
          rows.push({ date, time, title, link, organizer, category, language, certificate });
        }
      }
      return rows;
    }

    function withinRange(d, s, e) { return d >= s && d <= e; }

    function todayStrLima() {
      const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Lima' }));
      const Y = d.getFullYear();
      const M = String(d.getMonth() + 1).padStart(2, '0');
      const D = String(d.getDate()).padStart(2, '0');
      return `${Y}-${M}-${D}`;
    }

    function updateDateFilter(dayNames) {
      const select = document.getElementById('dayFilter');
      select.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'all';
      optAll.textContent = 'All days';
      select.appendChild(optAll);
      Array.from(allDates).sort().forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = dayNames[date] || date;
        select.appendChild(option);
      });
    }

    function initLanguageFilter(rows) {
      const sel = document.getElementById('langFilter');
      sel.innerHTML = '<option value="__ALL__">All languages</option>';
      const langs = Array.from(new Set(
        rows.map(r => (r.language || '').trim()).filter(Boolean)
      )).sort((a, b) => a.localeCompare(b));
      langs.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l;
        opt.textContent = l;
        sel.appendChild(opt);
      });
      sel.onchange = () => filterEvents(WEEKS.find(w => w.key === 'current').dayNames);
    }

    function renderEvents(filteredEvents, dayNames) {
      const container = document.getElementById('eventsContainer');
      container.innerHTML = '';
      
      if (filteredEvents.length === 0) {
        container.innerHTML = '<div class="loading"><p>No events found</p></div>';
        document.getElementById('visibleEvents').textContent = '0';
        return;
      }

      const eventsByDay = {};
      filteredEvents.forEach(ev => {
        (eventsByDay[ev.date] ||= []).push(ev);
      });

      const todayStr = todayStrLima();

      Object.keys(eventsByDay).sort().forEach(date => {
        const isPast = date < todayStr;
        const isToday = date === todayStr;
        const daySection = document.createElement('div');
        daySection.className = 'day-section';
        const count = eventsByDay[date].length;

        const dayHeader = document.createElement('div');
        dayHeader.className = `day-header ${isPast ? 'past' : ''} ${isToday ? 'today' : ''}`;
        const shouldCollapse = !isToday;
        if (shouldCollapse) dayHeader.classList.add('collapsed');

        dayHeader.innerHTML = `
          <div style="display:flex; align-items:center;">
            <div class="day-title">${(dayNames[date] || date)} <span style="color:#999; font-weight:600;">(${count})</span></div>
            ${isToday ? '<span class="today-badge">üìç TODAY</span>' : ''}
          </div>
          <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-secondary" data-day="${date}" onclick="event.stopPropagation()">üì• Export day (.ics)</button>
            <span class="collapse-icon">${shouldCollapse ? '‚ñ∂' : '‚ñº'}</span>
          </div>
        `;

        const dayContent = document.createElement('div');
        dayContent.className = `day-content ${shouldCollapse ? 'collapsed' : ''}`;
        if (shouldCollapse) dayContent.style.maxHeight = '0';

        dayHeader.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          dayContent.classList.toggle('collapsed');
          dayHeader.classList.toggle('collapsed');
          if (dayContent.classList.contains('collapsed')) {
            dayContent.style.maxHeight = '0';
          } else {
            dayContent.style.maxHeight = dayContent.scrollHeight + 'px';
          }
        });

        const eventsGrid = document.createElement('div');
        eventsGrid.className = 'events-grid';

        eventsByDay[date].forEach(event => {
          const card = document.createElement('div');
          card.className = 'event-card';

          const isCertified = (() => {
            const raw = (event.certificate || '').toString().trim().toLowerCase();
            if (!raw) return false;
            return ['yes', 'y', 'true', '1', 'certified', 's√≠', 'si'].includes(raw) || (raw !== 'no' && raw !== 'false' && raw !== '0');
          })();

          if (isCertified) card.classList.add('certified');

          card.innerHTML = `
            <div class="category-tag">${event.category || 'General'}</div>
            <div class="event-time">üïê ${event.time}</div>
            <div class="event-title">
              ${event.title}
              ${isCertified ? '<span class="badge badge-cert">Certified</span>' : ''}
            </div>
            <div class="event-organizer">üìç ${event.organizer || '‚Äî'}</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin: 6px 0 10px 0;">
              ${event.language ? `<span class="badge badge-lang">${event.language}</span>` : ''}
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              ${event.link ? `<a href="${event.link}" target="_blank" rel="noopener noreferrer" class="event-link">Join ‚Üí</a>` : ''}
              <button class="ics-btn" data-ics="${event.date}__${event.time}__${(event.title || '').replace(/\s+/g, '_')}">.ics</button>
            </div>
          `;

          eventsGrid.appendChild(card);
        });

        dayContent.appendChild(eventsGrid);
        daySection.appendChild(dayHeader);
        daySection.appendChild(dayContent);
        container.appendChild(daySection);
      });

      document.getElementById('visibleEvents').textContent = String(filteredEvents.length);

      document.querySelectorAll('[data-day]').forEach(btn => {
        btn.onclick = () => exportICS(filteredEvents.filter(e => e.date === btn.dataset.day), `events-${btn.dataset.day}.ics`);
      });
      document.querySelectorAll('[data-ics]').forEach(btn => {
        btn.onclick = () => {
          const [d, t] = btn.dataset.ics.split('__');
          const ev = filteredEvents.find(e => e.date === d && e.time === t);
          if (ev) exportICS([ev], `event-${d}-${t.replace(':', '')}.ics`);
        };
      });
    }

    function filterEvents(dayNames) {
      const select = document.getElementById('dayFilter');
      const search = (document.getElementById('searchFilter').value || '').toLowerCase();
      const langSel = document.getElementById('langFilter');
      const langVal = (langSel && langSel.value) ? langSel.value : '__ALL__';

      let selectedDay = select.value;

      if (showTodayOnly) {
        const t = todayStrLima();
        if (allDates.has(t)) {
          selectedDay = t;
          select.value = t;
        } else {
          selectedDay = 'all';
          select.value = 'all';
        }
      }

      const out = events.filter(ev => {
        const okDay = (selectedDay === 'all') || ev.date === selectedDay;
        const hay = [ev.title, ev.organizer, ev.category].filter(Boolean).join(' ').toLowerCase();
        const okSearch = !search || hay.includes(search);
        const evLang = (ev.language || '').trim();
        const okLang = (langVal === '__ALL__') || evLang === langVal;
        return okDay && okSearch && okLang;
      });

      renderEvents(out, dayNames);
    }

    function toICS(list) {
      const lines = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//Critical Care Webinars//EN"];
      const now = new Date().toISOString().replace(/[-:]/g, "").replace(/\.\d{3}Z/, "Z");
      
      for (const ev of list) {
        const [h, m] = (ev.time || "00:00").split(':').map(n => parseInt(n || "0", 10));
        const [Y, Mo, D] = ev.date.split('-').map(n => parseInt(n, 10));
        const start = new Date(Y, (Mo - 1), D, h, m, 0);
        const end = new Date(start.getTime() + 60 * 60 * 1000);
        const fmt = d => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().replace(/[-:]/g, "").replace(/\.\d{3}Z/, "Z");
        
        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${Y}${String(Mo).padStart(2, '0')}${String(D).padStart(2, '0')}-${String(h).padStart(2, '0')}${String(m).padStart(2, '0')}@ccw`);
        lines.push(`DTSTAMP:${now}`);
        lines.push(`DTSTART:${fmt(start)}`);
        lines.push(`DTEND:${fmt(end)}`);
        lines.push(`SUMMARY:${(ev.title || 'Event').replace(/[\r\n,]/g, ' ')}`);
        lines.push(`DESCRIPTION:${[(ev.organizer || ''), (ev.category || '')].filter(Boolean).join(' | ').replace(/[\r\n,]/g, ' ')}`);
        if (ev.link) lines.push(`URL:${ev.link}`);
        lines.push("END:VEVENT");
      }
      
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function exportICS(list, filename) {
      const blob = new Blob([toICS(list)], { type: "text/calendar" });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement("a"), { href: url, download: filename });
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function loadWeek(week) {
      const url = buildSheetUrl(week.gid);
      console.log(`Loading ${week.label} from:`, url);
      
      try {
        const res = await fetch(url, { 
          cache: "no-store",
          mode: 'cors',
          headers: {
            'Accept': 'text/csv,text/plain,*/*'
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const csv = await res.text();
        
        if (!csv || csv.trim().length === 0) {
          throw new Error('Empty response received');
        }
        
        console.log(`‚úì Loaded ${week.label}: ${csv.substring(0, 100)}...`);
        
        const parsed = parseCSV(csv);
        const filtered = parsed.filter(e => withinRange(e.date, week.start, week.end));
        
        console.log(`‚úì Parsed ${filtered.length} events for ${week.label}`);
        
        return filtered.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
        
      } catch (err) {
        console.error(`‚úó Failed to load ${week.label}:`, err);
        throw new Error(`Cannot access ${week.label}.\n\nPossible causes:\n‚Ä¢ Sheet not published as CSV\n‚Ä¢ Incorrect GID\n‚Ä¢ Network/CORS issue\n\nURL: ${url}\n\nError: ${err.message}`);
      }
    }

    function updateFutureCounter() {
      const nowLima = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Lima' }));
      const count = events.reduce((acc, e) => {
        const [Y, Mo, D] = e.date.split('-').map(Number);
        const [h, m] = (e.time || '00:00').split(':').map(n => parseInt(n || "0", 10));
        const dt = new Date(Y, Mo - 1, D, h, m, 0);
        return acc + (dt >= nowLima ? 1 : 0);
      }, 0);
      document.getElementById('futureEvents').textContent = String(count);
    }

    async function loadAll() {
      const $loading = document.getElementById('loadingSection');
      const $error = document.getElementById('errorSection');
      const $main = document.getElementById('mainContent');

      $loading.style.display = 'block';
      $error.style.display = 'none';
      $main.style.display = 'none';

      try {
        if (typeof Papa === 'undefined') {
          throw new Error('PapaParse library failed to load. Please refresh the page.');
        }

        const [currentList, prevList] = await Promise.all([
          loadWeek(WEEKS.find(w => w.key === 'current')),
          loadWeek(WEEKS.find(w => w.key === 'prev'))
        ]);

        events.length = 0;
        allDates.clear();
        currentList.forEach(e => {
          events.push(e);
          allDates.add(e.date);
        });

        document.getElementById('totalEvents').textContent = String(events.length);
        initLanguageFilter(events);
        updateDateFilter(WEEKS.find(w => w.key === 'current').dayNames);

        const t = todayStrLima();
        const toggleBtn = document.getElementById('toggleTodayBtn');
        if (allDates.has(t)) {
          showTodayOnly = true;
          toggleBtn.classList.add('active');
          toggleBtn.textContent = '‚Ü©Ô∏è Show all';
        } else {
          showTodayOnly = false;
          toggleBtn.classList.remove('active');
          toggleBtn.textContent = 'üü£ Today only';
        }

        updateFutureCounter();
        filterEvents(WEEKS.find(w => w.key === 'current').dayNames);

        const prev = WEEKS.find(w => w.key === 'prev');
        archive['prev'] = {
          flat: prevList.slice(),
          byDay: prevList.reduce((acc, ev) => {
            (acc[ev.date] ||= []).push(ev);
            return acc;
          }, {})
        };

        const hasArchive = archive['prev'].flat.length > 0;
        document.getElementById('archiveBlock').style.display = hasArchive ? 'block' : 'none';

        $loading.style.display = 'none';
        $main.style.display = 'block';

      } catch (err) {
        console.error(err);
        $loading.style.display = 'none';
        $error.style.display = 'block';
        $error.innerHTML = `
          <strong>‚ö†Ô∏è Error loading events</strong><br>
          ${err.message}<br><br>
          Please verify that:<br>
          ‚Ä¢ Both sheets are <em>Published to the web</em> as CSV<br>
          ‚Ä¢ PapaParse library loaded correctly<br>
          ‚Ä¢ Your internet connection is stable<br><br>
          <button class="btn-secondary" id="retryBtn">Retry</button>
        `;
        document.getElementById('retryBtn').onclick = loadAll;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('reloadBtn').onclick = () => { loadAll(); };
      document.getElementById('searchFilter').oninput = () => filterEvents(WEEKS.find(w => w.key === 'current').dayNames);
      document.getElementById('dayFilter').onchange = () => {
        showTodayOnly = false;
        const btn = document.getElementById('toggleTodayBtn');
        btn.classList.remove('active');
        btn.textContent = 'üü£ Today only';
        filterEvents(WEEKS.find(w => w.key === 'current').dayNames);
      };
      document.getElementById('exportWeek').onclick = () => exportICS(events, 'events-current-week.ics');
      document.getElementById('toggleTodayBtn').onclick = () => {
        showTodayOnly = !showTodayOnly;
        const btn = document.getElementById('toggleTodayBtn');
        if (showTodayOnly) {
          btn.classList.add('active');
          btn.textContent = '‚Ü©Ô∏è Show all';
        } else {
          btn.classList.remove('active');
          btn.textContent = 'üü£ Today only';
          document.getElementById('dayFilter').value = 'all';
        }
        filterEvents(WEEKS.find(w => w.key === 'current').dayNames);
      };

      loadAll();
      setInterval(() => { loadAll(); }, 300000);
      setInterval(() => { updateFutureCounter(); }, 60000);
    });
  </script>
</body>
</html>
