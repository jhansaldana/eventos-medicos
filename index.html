<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Critical Care Webinars</title>

  <!-- PapaParse para CSV robusto -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #111;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header {
      background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 1.1em; }
    .loading {
      background: white; border-radius: 15px; padding: 40px; text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%;
      width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
    .error {
      background: #ffe6e6; border: 2px solid #ff4444; border-radius: 10px;
      padding: 20px; margin-bottom: 30px; color: #cc0000;
    }
    .filters {
      background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
    }
    .filter-label { font-weight: bold; color: #667eea; }
    select, input[type="text"] {
      padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; outline: none; transition: all 0.3s;
      background: #fff;
    }
    select:focus, input[type="text"]:focus { border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .day-section { margin-bottom: 30px; }
    .day-header {
      background: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
    }
    .day-title { color: #667eea; font-size: 1.5em; font-weight: bold; }
    .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .event-card {
      background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s; border-left: 5px solid #667eea;
    }
    .event-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .event-time { color: #764ba2; font-weight: bold; font-size: 1.1em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .event-title { color: #333; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; line-height: 1.4; }
    .event-organizer { color: #666; font-size: 0.9em; margin-bottom: 15px; font-style: italic; }
    .event-link, .ics-btn {
      display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
      padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s; border: none; cursor: pointer;
    }
    .event-link:hover, .ics-btn:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
    .btn-secondary {
      background: white; color: #667eea; border: 2px solid #667eea; padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all .3s;
    }
    .btn-secondary:hover { background: #667eea; color: #fff; }
    .category-tag {
      display: inline-block; background: #f0f0f0; color: #667eea; padding: 5px 12px; border-radius: 15px;
      font-size: 0.85em; margin-bottom: 10px; font-weight: 600;
    }
    .stats {
      background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;
    }
    .stat-item { text-align: center; }
    .stat-number { font-size: 2.5em; color: #667eea; font-weight: bold; }
    .stat-label { color: #666; font-size: 1em; }
    .small-note { font-size: .85em; color:#555; }
    @media (max-width: 768px) {
      h1 { font-size: 1.8em; } .events-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>📅 Critical Care Webinars</h1>
      <p class="subtitle">
        Semana del 6 al 11 de Octubre 2025 · <span class="small-note">Horarios según tu hoja (recomendado America/Lima)</span>
      </p>
    </header>

    <div id="loadingSection" class="loading">
      <div class="loading-spinner"></div>
      <p>Cargando eventos desde Google Sheets...</p>
    </div>

    <div id="errorSection" class="error" style="display:none;"></div>

    <div id="mainContent" style="display:none;">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="totalEvents">0</div>
          <div class="stat-label">Eventos Totales</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="visibleEvents">0</div>
          <div class="stat-label">Eventos Visibles</div>
        </div>
        <div class="stat-item">
          <button id="exportWeek" class="btn-secondary">📥 Exportar semana (.ics)</button>
          <div class="small-note" style="margin-top:6px">Crea un archivo para Google/Outlook</div>
        </div>
      </div>

      <div class="filters">
        <span class="filter-label">Filtrar por:</span>
        <select id="dayFilter"></select>
        <input type="text" id="searchFilter" placeholder="Buscar por tema, organizador o especialidad…">
        <button id="reloadBtn" class="btn-secondary">🔄 Actualizar</button>
      </div>

      <div id="eventsContainer"></div>
    </div>
  </div>

  <script>
    // ==============================
    // CONFIG
    // ==============================
    // 👇 Reemplaza por TU enlace de Sheet publicado como CSV
    const GOOGLE_SHEET_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgscb3CQReXXkS1S7Sgj_e-COWBuQ38YO-eJ9Cr3wOvV8MCPGFt-s-01KLNkCpi00zqFnMvMsL4zTi/pub?gid=0&single=true&output=csv';

    // Día -> etiqueta bonita (opcional)
    const dayNames = {
      '2025-10-06': 'Lunes 6 de Octubre',
      '2025-10-07': 'Martes 7 de Octubre',
      '2025-10-08': 'Miércoles 8 de Octubre',
      '2025-10-09': 'Jueves 9 de Octubre',
      '2025-10-10': 'Viernes 10 de Octubre',
      '2025-10-11': 'Sábado 11 de Octubre'
    };

    // ==============================
    // STATE
    // ==============================
    let events = [];
    let allDates = new Set();

    // ==============================
    // CSV PARSER ROBUSTO
    // ==============================
    function normalizeDate(x) {
      if (!x) return "";
      const s = String(x).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // ya OK
      // dd/mm/yyyy o d/m/yy
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        let [, d, mo, y] = m;
        if (y.length === 2) y = (Number(y) > 50 ? "19" : "20") + y;
        return `${y.padStart(4,"0")}-${mo.padStart(2,"0")}-${d.padStart(2,"0")}`;
      }
      return ""; // formato raro -> descartar
    }

    function normalizeTime(x) {
      if (x === null || x === undefined) return "";
      let s = String(x).trim().toLowerCase();
      // quita am/pm sueltos si no estás usando 12h
      s = s.replace(/\s*[ap]\.?m\.?$/,"");
      if (/^\d{1,2}:\d{2}$/.test(s)) {
        const [h, m] = s.split(":");
        return `${h.padStart(2,"0")}:${m}`;
      }
      if (/^\d{1,2}$/.test(s)) return `${s.padStart(2,"0")}:00`;
      const f = parseFloat(s.replace(",", "."));
      if (!isNaN(f)) { // 6.5 -> 06:30
        const h = Math.floor(f);
        const m = Math.round((f - h) * 60);
        return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
      }
      return "";
    }

    function getField(row, keys) {
      for (const k of keys) {
        if (row[k] !== undefined && String(row[k]).trim() !== "") return String(row[k]).trim();
      }
      return "";
    }

    function parseCSV(csv) {
      const result = Papa.parse(csv, {
        header: true,
        skipEmptyLines: "greedy",
        transformHeader: h => String(h).trim().toLowerCase()
      });

      if (result.errors?.length) console.warn("PapaParse errors:", result.errors.slice(0,3));

      const rows = [];
      for (const row of result.data) {
        const date = normalizeDate(getField(row, ["date","fecha","día","dia"]));
        const time = normalizeTime(getField(row, ["time","hora","start","inicio"]));
        const title = getField(row, ["title","título","titulo","tema","subject"]);
        const link = getField(row, ["link","enlace","url"]);
        const organizer = getField(row, ["organizer","organizador","host","org","institucion","institución"]);
        const category = getField(row, ["category","categoría","categoria","especialidad"]);

        if (date && time && title) {
          rows.push({ date, time, title, link, organizer, category });
          allDates.add(date);
        }
      }
      return rows;
    }

    // ==============================
    // RENDER
    // ==============================
    function updateDateFilter() {
      const select = document.getElementById('dayFilter');
      select.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'all';
      optAll.textContent = 'Todos los días';
      select.appendChild(optAll);

      Array.from(allDates).sort().forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = dayNames[date] || date;
        select.appendChild(option);
      });
    }

    function renderEvents(filteredEvents) {
      const container = document.getElementById('eventsContainer');
      container.innerHTML = '';

      if (filteredEvents.length === 0) {
        container.innerHTML = '<div class="loading"><p>No se encontraron eventos</p></div>';
        document.getElementById('visibleEvents').textContent = '0';
        return;
      }

      const eventsByDay = {};
      filteredEvents.forEach(ev => {
        if (!eventsByDay[ev.date]) eventsByDay[ev.date] = [];
        eventsByDay[ev.date].push(ev);
      });

      Object.keys(eventsByDay).sort().forEach(date => {
        const daySection = document.createElement('div');
        daySection.className = 'day-section';

        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        dayHeader.innerHTML = `
          <div class="day-title">${dayNames[date] || date}</div>
          <button class="btn-secondary" data-day="${date}">📥 Exportar día (.ics)</button>
        `;
        daySection.appendChild(dayHeader);

        const eventsGrid = document.createElement('div');
        eventsGrid.className = 'events-grid';

        eventsByDay[date].forEach(event => {
          const card = document.createElement('div');
          card.className = 'event-card';
          card.innerHTML = `
            <div class="category-tag">${event.category || 'General'}</div>
            <div class="event-time">🕐 ${event.time}</div>
            <div class="event-title">${event.title}</div>
            <div class="event-organizer">📍 ${event.organizer || '—'}</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              ${event.link ? `<a href="${event.link}" target="_blank" class="event-link">Unirse al evento →</a>` : ''}
              <button class="ics-btn" data-ics="${event.date}__${event.time}__${(event.title||'').replace(/\s+/g,'_')}">.ics</button>
            </div>
          `;
          eventsGrid.appendChild(card);
        });

        daySection.appendChild(eventsGrid);
        container.appendChild(daySection);
      });

      // contar visibles
      document.getElementById('visibleEvents').textContent = String(filteredEvents.length);

      // wire: export day
      document.querySelectorAll('[data-day]').forEach(btn => {
        btn.onclick = () => exportICS(
          filteredEvents.filter(e => e.date === btn.dataset.day),
          `eventos-${btn.dataset.day}.ics`
        );
      });

      // wire: per-event ics
      document.querySelectorAll('[data-ics]').forEach(btn => {
        btn.onclick = () => {
          const [d,t,slug] = btn.dataset.ics.split('__');
          const ev = filteredEvents.find(e => e.date===d && e.time===t);
          if (ev) exportICS([ev], `evento-${d}-${t.replace(':','')}.ics`);
        };
      });
    }

    // ==============================
    // FILTROS
    // ==============================
    function filterEvents() {
      const dayFilter = document.getElementById('dayFilter').value;
      const search = (document.getElementById('searchFilter').value || '').toLowerCase();

      const out = events.filter(ev => {
        const okDay = (dayFilter === 'all') || ev.date === dayFilter;
        const hay = [ev.title, ev.organizer, ev.category].filter(Boolean).join(' ').toLowerCase();
        const okSearch = !search || hay.includes(search);
        return okDay && okSearch;
      });

      renderEvents(out);
    }

    // ==============================
    // ICS
    // ==============================
    function toICS(eventsList) {
      const lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Critical Care Webinars//Jhan//ES"
      ];
      const now = new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z/,"Z");

      for (const ev of eventsList) {
        // Evitar problemas: construir un Date usando fecha y hora locales y pasarlo a UTC
        const [h, m] = (ev.time || "00:00").split(':').map(n => parseInt(n || "0", 10));
        const [Y, Mo, D] = ev.date.split('-').map(n => parseInt(n, 10));
        const start = new Date(Y, (Mo-1), D, h, m, 0);
        // Duración por defecto: 60 min si no hay fin específico
        const end = new Date(start.getTime() + 60*60*1000);

        const fmt = d => new Date(d.getTime() - d.getTimezoneOffset()*60000) // to UTC ISO
                          .toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z/,"Z");

        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${Y}${String(Mo).padStart(2,'0')}${String(D).padStart(2,'0')}-${String(h).padStart(2,'0')}${String(m).padStart(2,'0')}@ccw`);
        lines.push(`DTSTAMP:${now}`);
        lines.push(`DTSTART:${fmt(start)}`);
        lines.push(`DTEND:${fmt(end)}`);
        lines.push(`SUMMARY:${(ev.title||'Evento').replace(/[\r\n,]/g,' ')}`);
        lines.push(`DESCRIPTION:${[(ev.organizer||''),(ev.category||'')].filter(Boolean).join(' | ').replace(/[\r\n,]/g,' ')}`);
        if (ev.link) lines.push(`URL:${ev.link}`);
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function exportICS(list, filename) {
      const blob = new Blob([toICS(list)], {type:"text/calendar"});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement("a"), { href: url, download: filename });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ==============================
    // LOAD
    // ==============================
    async function loadEvents() {
      const $loading = document.getElementById('loadingSection');
      const $error = document.getElementById('errorSection');
      const $main = document.getElementById('mainContent');

      $loading.style.display = 'block';
      $error.style.display = 'none';
      $main.style.display = 'none';

      try {
        const res = await fetch(GOOGLE_SHEET_URL, { cache: "no-store" });
        if (!res.ok) throw new Error('No se pudo cargar el CSV publicado');
        const csv = await res.text();

        // limpiar estado
        events.length = 0;
        allDates.clear();

        // parsear
        const parsed = parseCSV(csv);
        // ordenar por fecha y hora
        parsed.sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
        parsed.forEach(e => events.push(e));

        // UI
        document.getElementById('totalEvents').textContent = String(events.length);
        updateDateFilter();
        filterEvents();

        $loading.style.display = 'none';
        $main.style.display = 'block';
      } catch (err) {
        console.error(err);
        $loading.style.display = 'none';
        $error.style.display = 'block';
        $error.innerHTML = `
          <strong>⚠️ Error al cargar eventos</strong><br>
          ${err.message}<br><br>
          Verifica que:<br>
          • La hoja esté <em>Publicada en la web</em> como CSV<br>
          • El enlace sea el correcto (mismo <code>gid</code>)<br><br>
          <button class="btn-secondary" id="retryBtn">Reintentar</button>
        `;
        document.getElementById('retryBtn').onclick = loadEvents;
      }
    }

    // ==============================
    // INIT + LISTENERS
    // ==============================
    document.getElementById('reloadBtn').onclick = loadEvents;
    document.getElementById('searchFilter').oninput = filterEvents;
    document.getElementById('dayFilter').onchange = filterEvents;
    document.getElementById('exportWeek').onclick = () => {
      const now = new Date();
      const end = new Date(now.getTime() + 7*24*60*60*1000);
      const inWeek = events.filter(e => {
        const [Y,Mo,D] = e.date.split('-').map(n=>parseInt(n,10));
        const [h,m] = (e.time||"00:00").split(':').map(n=>parseInt(n||"0",10));
        const dt = new Date(Y,Mo-1,D,h,m,0);
        return dt >= now && dt <= end;
      });
      exportICS(inWeek, 'eventos-semana.ics');
    };

    // carga inicial
    loadEvents();
    // auto-refresh cada 5 min
    setInterval(loadEvents, 300000);
  </script>
</body>
</html>
